stages:
  - build
  - deploy
build-war:
  image: kinnaradigitalstudio/kecak-builder
  stage: build
  tags: 
    - sandbox
  script:
    - cd "${CI_PROJECT_DIR}"/wflow-app && sh kecak_make.sh
  artifacts:
    paths:
      - wflow-consoleweb/target/kecak.war
    expire_in: 1 day

deploy-to-sandbox:
  stage: deploy
  image: docker:19.03.12
  before_script:
    - docker info
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && ssh-keyscan -H "$SERVER_HOSTNAME" > ~/.ssh/known_hosts'
  script:
    - scp wflow-consoleweb/target/kecak.war $GIT_USERNAME@$SERVER_HOSTNAME:/home/fahmi.mahmud/docker-image-kecak-workflow
    - ssh $GIT_USERNAME@$SERVER_HOSTNAME python3 /home/fahmi.mahmud/docker-image-kecak-workflow/docker-build.py
    - ssh $GIT_USERNAME@$SERVER_HOSTNAME /home/ubuntu/docker-compose-kecak-workflow/update-docker-image.sh
